#!/bin/sh

# Build app docker compose
APP_FILE=app/docker-compose.yml
APP_FILE_VOLUME=app/docker-compose.volumes
echo -n > $APP_FILE_VOLUME

cat > $APP_FILE <<COMPOSE
version: '3'
services:
  mftf:
    volumes:
COMPOSE

if [ -d "app/tests/acceptance" ]; then
  TEST="tests/acceptance/tests/functional/Magento/FunctionalTest"
  for EXTENSION in `ls app/$TEST`; do
    if [ -d "app/$TEST/$EXTENSION" ]; then
      echo "      - ./app/$TEST/$EXTENSION:/var/www/html/dev/$TEST/$EXTENSION" \
        >> $APP_FILE_VOLUME
      APP_COMPOSE=1
    fi
  done

  TEST="tests/acceptance/tests/functional/Magestore"
  if [ -d "app/$TEST" ]; then
    echo "      - ./app/$TEST:/var/www/html/dev/$TEST" \
      >> $APP_FILE_VOLUME
    APP_COMPOSE=1
  fi
fi

if [ -d "app/tests/api-functional" ]; then
  TEST="tests/api-functional/testsuite/Magento"
  for EXTENSION in `ls app/$TEST`; do
    if [ -d "app/$TEST/$EXTENSION" ]; then
      echo "      - ./app/$TEST/$EXTENSION:/var/www/html/dev/$TEST/$EXTENSION" \
        >> $APP_FILE_VOLUME
      APP_COMPOSE=1
    fi
  done
fi

if [ -d "app/tests/static" ]; then
  TEST="tests/static"
  for EXTENSION in `ls app/$TEST`; do
    if [ -d "app/$TEST/$EXTENSION" ]; then
      echo "      - ./app/$TEST/$EXTENSION:/var/www/html/dev/$TEST/$EXTENSION" \
        >> $APP_FILE_VOLUME
      APP_COMPOSE=1
    fi
  done
fi


if [ -d "app/tests/functional" ]; then
  TEST="tests/functional/tests/app/Magento"
  for EXTENSION in `ls app/$TEST`; do
    if [ -d "app/$TEST/$EXTENSION" ]; then
      echo "      - ./app/$TEST/$EXTENSION:/var/www/html/dev/$TEST/$EXTENSION" \
        >> $APP_FILE_VOLUME
      APP_COMPOSE=1
    fi
  done
fi

cat $APP_FILE_VOLUME >> $APP_FILE

cat >> $APP_FILE <<COMPOSE
  functional:
    volumes:
COMPOSE

cat $APP_FILE_VOLUME >> $APP_FILE

# Run compose up
if [ -z "$APP_COMPOSE" ]; then
  # No test
  docker-compose $1 $2 $3 $4
else
  # Run with test app compose
  docker-compose -f docker-compose.yml -f app/docker-compose.yml $1 $2 $3 $4 --force-recreate
fi
